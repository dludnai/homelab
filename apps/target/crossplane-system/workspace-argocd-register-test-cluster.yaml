url: https://stevehipwell.github.io/helm-charts
chart: k8s-resources
version: 0.1.0
values:
  resources:
    - apiVersion: opentofu.upbound.io/v1beta1
      kind: Workspace
      name: argocd-register-test-cluster
      content:
        spec:
          providerConfigRef:
            name: default
          forProvider:
            initArgs:
              - "-upgrade=true"
            source: Inline
            vars:
              - key: cluster_name
                value: "rke2-test-cluster"
            env:
              - name: TF_VAR_kube_config
                secretKeyRef:
                  namespace: crossplane-system
                  name: rke2-test-cluster-outputs
                  key: kube_config
            module: |
              terraform {
                required_providers {
                  kubernetes = {
                    source  = "hashicorp/kubernetes"
                    version = "~> 2.0"
                  }
                }
                backend "kubernetes" {
                  secret_suffix     = "argocd-register-test-cluster"
                  namespace         = "crossplane-system"
                  in_cluster_config = true
                }
              }

              variable "cluster_name" {
                type = string
              }

              variable "kube_config" {
                type      = string
                sensitive = true
              }

              # In-cluster provider for creating ArgoCD secret on target cluster
              provider "kubernetes" {
                config_path = ""
              }

              locals {
                parsed    = yamldecode(var.kube_config)
                server    = local.parsed.clusters[0].cluster.server
                ca_data   = try(local.parsed.clusters[0].cluster["certificate-authority-data"], "")
                token     = local.parsed.users[0].user.token
              }

              resource "kubernetes_secret_v1" "argocd_cluster" {
                metadata {
                  name      = var.cluster_name
                  namespace = "argocd"
                  labels = {
                    "argocd.argoproj.io/secret-type" = "cluster"
                  }
                }
                type = "Opaque"
                data = {
                  name   = var.cluster_name
                  server = local.server
                  config = jsonencode({
                    bearerToken = local.token
                    tlsClientConfig = {
                      insecure = local.ca_data == "" ? true : false
                      caData   = local.ca_data
                    }
                  })
                }
              }

              output "cluster_server" {
                value     = local.server
                sensitive = true
              }
          writeConnectionSecretToRef:
            namespace: crossplane-system
            name: argocd-register-test-cluster-outputs
